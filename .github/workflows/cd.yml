name: 'Continuous Delivery'

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed
    branches:
      - main
      - develop
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
    paths:
      - 'challenge/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/cd.yml'

env:
  REGISTRY: ghcr.io

defaults:
  run:
    shell: bash

jobs:
  docker:
    runs-on: ubuntu-latest
    # Only run if CI succeeded or triggered manually/by push
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    permissions:
      contents: read
      packages: write
    outputs:
      image_id: ${{ steps.meta.outputs.image_id }}
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image metadata
        id: meta
        run: |
          IMAGE_ID="${REGISTRY}/${GITHUB_REPOSITORY}"
          IMAGE_ID="${IMAGE_ID,,}"
          echo "image_id=${IMAGE_ID}" >> "$GITHUB_OUTPUT"
          echo "image_tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.image_id }}:latest
            ${{ steps.meta.outputs.image_id }}:${{ steps.meta.outputs.image_tag }}

  deploy:
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Set service name based on branch
        id: service
        run: |
          # Determine branch name from different event types
          if [[ "${{ github.event_name }}" == "push" ]]; then
            BRANCH="${{ github.ref_name }}"
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi

          # Set service name based on branch
          if [[ "$BRANCH" == "develop" ]]; then
            echo "name=${{ secrets.CLOUD_RUN_SERVICE }}-dev" >> "$GITHUB_OUTPUT"
          else
            echo "name=${{ secrets.CLOUD_RUN_SERVICE }}" >> "$GITHUB_OUTPUT"
          fi

          echo "Deploying from branch: $BRANCH"

      - name: Deploy to Cloud Run
        env:
          SERVICE_NAME: ${{ steps.service.outputs.name }}
          REGION: ${{ secrets.GCP_REGION }}
          IMAGE: ${{ needs.docker.outputs.image_id }}:${{ needs.docker.outputs.image_tag }}
        run: |
          gcloud run deploy "${SERVICE_NAME}" \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --project "${{ secrets.GCP_PROJECT }}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080

          # Get the service URL
          SERVICE_URL=$(gcloud run services describe "${SERVICE_NAME}" \
            --region "${REGION}" \
            --project "${{ secrets.GCP_PROJECT }}" \
            --format 'value(status.url)')

          echo "Service deployed successfully!"
          echo "Service URL: ${SERVICE_URL}"